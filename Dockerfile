FROM alpine:latest
RUN addgroup -S samba-g && adduser -D -H -S -s /bin/false -g samba-g samba && apk --no-cache upgrade && apk --no-cache add samba-common-tools samba-server && mkdir /samba && mkdir /tmp/samba && (echo test; echo test) | smbpasswd -s -a samba && rm /etc/samba/smb.conf && cp -f /var/lib/samba/private/secrets.tdb /tmp/samba/secrets.tdb && cp -f /var/lib/samba/private/passdb.tdb /tmp/samba/passdb.tdb && chown -R samba:samba-g /tmp/samba && chown -R samba:samba-g /var/log/samba && printf "[global]\nworkgroup = WORKGROUP\nserver string = Samba Hardened Server\nserver role = standalone server\nlog file = /dev/stdout\ndns proxy = no \nprotocol = SMB3\nclient min protocol = SMB3\nserver multi channel support = no\nuse sendfile = yes\naio read size = 2048\naio write size = 2048\nwrite cache size = 1024000\nsmb encrypt = required\nencrypt passwords = yes\nsmb ports = 4045\nunix password sync = no\nsecurity = user\ndirectory mask = 0775\nforce create mode = 0664\nforce directory mode = 0775\nlogging=syslog\nload printers = no\nprinting = bsd\nprintcap name = /dev/null\nlock directory = /tmp/samba\nstate directory = /tmp/samba\ncache directory = /tmp/samba\npid directory = /tmp/samba\nprivate dir = /tmp/samba\nncalrpc dir = /tmp/samba\nforce user = samba\nforce group = samba-g\nunix extensions = no\n\n[samba]\npath = /samba\nvalid users = samba\nbrowsable = yes\nwritable = yes\nread only = no\nvfs objects = catia fruit streams_xattr\nfruit:model = MacPro\nfruit:advertise_fullsync = true\nfruit:aapl = yes\nfruit:time machine = yes" > /etc/samba/smb.conf
EXPOSE 4045/tcp
USER samba:samba-g
ENTRYPOINT ["smbd", "-FS", "--no-process-group"]
